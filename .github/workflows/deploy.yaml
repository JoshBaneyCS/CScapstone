name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (do not actually deploy)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  PROD_IMAGE: ghcr.io/joshbaneycs/capstone-prod
  STAGING_IMAGE: ghcr.io/joshbaneycs/capstone-staging
  DEV_IMAGE: ghcr.io/joshbaneycs/capstone-dev

permissions:
  contents: write
  packages: read
  deployments: write

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      image_tag: ${{ steps.config.outputs.image_tag }}
      image_name: ${{ steps.config.outputs.image_name }}
      overlay_path: ${{ steps.config.outputs.overlay_path }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            ENVIRONMENT="production"
            IMAGE_TAG="${{ github.event.release.tag_name }}"
          else
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          fi

          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          case "$ENVIRONMENT" in
            production)
              OVERLAY_PATH="infra/k8s/overlays/prod"
              IMAGE_NAME="${{ env.PROD_IMAGE }}"
              ;;
            staging)
              OVERLAY_PATH="infra/k8s/overlays/staging"
              IMAGE_NAME="${{ env.STAGING_IMAGE }}"
              ;;
            development)
              OVERLAY_PATH="infra/k8s/overlays/dev"
              IMAGE_NAME="${{ env.DEV_IMAGE }}"
              ;;
          esac

          SHOULD_DEPLOY="true"
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            SHOULD_DEPLOY="false"
          fi

          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "overlay_path=$OVERLAY_PATH" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

          echo "## Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | $ENVIRONMENT |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | $IMAGE_NAME:$IMAGE_TAG |" >> $GITHUB_STEP_SUMMARY
          echo "| Overlay Path | $OVERLAY_PATH |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ github.event.inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY

  verify-images:
    name: Verify Image Exists
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists
        run: |
          IMAGE="${{ needs.prepare.outputs.image_name }}:${{ needs.prepare.outputs.image_tag }}"
          echo "Checking for image: $IMAGE"
          docker manifest inspect "$IMAGE" || {
            echo "Image not found: $IMAGE"
            exit 1
          }
          echo "Image found: $IMAGE"

  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    needs: [prepare, verify-images]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Kubernetes manifests
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          echo "Validating Kubernetes manifests..."
          kubectl kustomize ${{ needs.prepare.outputs.overlay_path }} > /tmp/manifests.yaml

          if [ -s /tmp/manifests.yaml ]; then
            echo "Manifests generated successfully"
            echo "Generated $(wc -l < /tmp/manifests.yaml) lines of YAML"
          else
            echo "No manifests generated"
            exit 1
          fi

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [prepare, pre-deploy-checks]
    if: needs.prepare.outputs.should_deploy == 'true'
    steps:
      - name: Wait for deployment to propagate
        run: sleep 60

      - name: Health check
        run: |
          case "${{ needs.prepare.outputs.environment }}" in
            production)
              HEALTH_URL="https://capstone-groupe.com/api/health"
              ;;
            staging)
              HEALTH_URL="https://staging.capstone-groupe.com/api/health"
              ;;
            development)
              HEALTH_URL="https://dev.capstone-groupe.com/api/health"
              ;;
          esac

          echo "Checking health at: $HEALTH_URL"

          for i in {1..5}; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 30s..."
            sleep 30
          done

          echo "Health check failed after 5 attempts"
        continue-on-error: true

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, verify-images, pre-deploy-checks, verify-deployment]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.prepare.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ needs.prepare.outputs.image_name }}:${{ needs.prepare.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Verify Image | ${{ needs.verify-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Deploy Checks | ${{ needs.pre-deploy-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify Deployment | ${{ needs.verify-deployment.result }} |" >> $GITHUB_STEP_SUMMARY

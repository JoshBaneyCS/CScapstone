# =============================================================================
# DEPLOYMENT.YAML - FRONTEND DEPLOYMENT
# =============================================================================
# This Deployment runs the React frontend served by nginx.
# The frontend is a static site - nginx serves pre-built HTML/CSS/JS files.
#
# Frontend Architecture:
# ----------------------
#   1. Vite builds React app into static files (HTML, CSS, JS)
#   2. Docker image contains nginx + built static files
#   3. nginx serves static files and proxies /api requests to backend
#   4. All routing is handled client-side by React Router
#
# Why nginx for the frontend?
# ---------------------------
#   - Extremely fast at serving static files
#   - Low resource usage
#   - Built-in gzip compression
#   - Handles SPA routing (fallback to index.html)
#   - Can proxy API requests (though we use Ingress in K8s)
#
# Commands:
#   kubectl apply -f deployment.yaml -n casino
#   kubectl get deployment frontend -n casino
#   kubectl get pods -l app=frontend -n casino
#   kubectl logs -f deployment/frontend -n casino
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: casino
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: web
    app.kubernetes.io/part-of: casino-capstone
  annotations:
    description: "React frontend for Casino Capstone served by nginx"
spec:
  # Number of replicas
  # 2 for high availability
  replicas: 2
  
  # Selector must match template labels
  selector:
    matchLabels:
      app: frontend
      app.kubernetes.io/name: frontend
  
  # Deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  
  # Minimum ready seconds
  minReadySeconds: 5
  
  # Revision history for rollbacks
  revisionHistoryLimit: 10
  
  # Pod template
  template:
    metadata:
      labels:
        app: frontend
        app.kubernetes.io/name: frontend
        app.kubernetes.io/component: web
        app.kubernetes.io/part-of: casino-capstone
      annotations:
        # Force redeployment when config changes
        checksum/config: "changeme"
    
    spec:
      # Security context for the pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 101     # nginx user in Alpine
        runAsGroup: 101    # nginx group
        fsGroup: 101
      
      containers:
        - name: frontend
          # Image - replace with your actual image
          image: casino-frontend:latest
          
          # Image pull policy
          imagePullPolicy: IfNotPresent
          
          # Container ports
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          
          # Environment variables (if needed at runtime)
          # Note: Most React config is baked in at build time
          env:
            # These are available to nginx, not React
            # React env vars must be VITE_ prefixed and set at BUILD time
            - name: NGINX_HOST
              value: "localhost"
            - name: NGINX_PORT
              value: "80"
          
          # Resource limits
          resources:
            requests:
              cpu: "50m"        # 0.05 CPU cores (nginx is very light)
              memory: "64Mi"    # 64 MB RAM
            limits:
              cpu: "200m"       # 0.2 CPU cores
              memory: "128Mi"   # 128 MB RAM
          
          # Liveness probe - is nginx alive?
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Readiness probe - is nginx ready to serve?
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # nginx needs to write to some dirs
            capabilities:
              drop:
                - ALL
          
          # Volume mounts
          volumeMounts:
            # nginx cache directory
            - name: nginx-cache
              mountPath: /var/cache/nginx
            # nginx pid file
            - name: nginx-pid
              mountPath: /var/run
            # Custom nginx config (optional - override default)
            # - name: nginx-config
            #   mountPath: /etc/nginx/conf.d/default.conf
            #   subPath: default.conf
      
      # Volumes
      volumes:
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-pid
          emptyDir: {}
        # Custom nginx config (optional)
        # - name: nginx-config
        #   configMap:
        #     name: frontend-nginx-config
      
      # Restart policy
      restartPolicy: Always
      
      # Termination grace period
      terminationGracePeriodSeconds: 30
      
      # Affinity - spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: frontend
                topologyKey: kubernetes.io/hostname

---
# =============================================================================
# OPTIONAL: NGINX CONFIGURATION CONFIGMAP
# =============================================================================
# Override the default nginx config if needed.
# The Dockerfile already includes a good config, but you can customize here.
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-nginx-config
  namespace: casino
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: web
data:
  default.conf: |
    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Gzip compression
        gzip on;
        gzip_min_length 1000;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/javascript application/json application/javascript;
        gzip_vary on;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # API proxy - forward /api requests to backend service
        location /api {
            proxy_pass http://backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Static file caching
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public";
        }

        # SPA routing - serve index.html for all non-file routes
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Health check endpoint
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

---
# =============================================================================
# HORIZONTAL POD AUTOSCALER
# =============================================================================
# Auto-scale frontend pods based on CPU/memory usage.
# =============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: frontend-hpa
  namespace: casino
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: web
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: frontend
  
  minReplicas: 2
  maxReplicas: 10
  
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
    scaleUp:
      stabilizationWindowSeconds: 0

---
# =============================================================================
# POD DISRUPTION BUDGET
# =============================================================================
# Ensure minimum availability during cluster maintenance.
# =============================================================================

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: frontend-pdb
  namespace: casino
  labels:
    app.kubernetes.io/name: frontend
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: frontend

---
# =============================================================================
# BUILD AND DEPLOYMENT NOTES
# =============================================================================
#
# Building the Docker image:
# --------------------------
# cd frontend
# docker build -t casino-frontend:latest .
#
# For minikube:
#   eval $(minikube docker-env)
#   docker build -t casino-frontend:latest .
#
# For kind:
#   docker build -t casino-frontend:latest .
#   kind load docker-image casino-frontend:latest
#
#
# Environment Variables at Build Time:
# ------------------------------------
# React environment variables must be set at BUILD time, not runtime!
# They are baked into the JavaScript bundle.
#
# docker build --build-arg VITE_API_URL=/api -t casino-frontend:latest .
#
# For different environments, build separate images:
#   docker build --build-arg VITE_API_URL=https://api.umgcgroupe.com -t casino-frontend:prod .
#
#
# Testing locally:
# ----------------
# docker run -p 5173:80 casino-frontend:latest
# # Open http://localhost:5173
#
# =============================================================================
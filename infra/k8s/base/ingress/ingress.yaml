# =============================================================================
# INGRESS.YAML - EXTERNAL ACCESS FOR CASINO CAPSTONE
# =============================================================================
# An Ingress exposes HTTP/HTTPS routes from outside the cluster to services
# within the cluster. It provides:
#   - External URL routing
#   - SSL/TLS termination
#   - Name-based virtual hosting
#   - Load balancing
#
# Domain: capstone-groupe.com
# ---------------------------
# This Ingress routes traffic for capstone-groupe.com to the casino application:
#   - capstone-groupe.com/* → Frontend (React app)
#   - capstone-groupe.com/api/* → Backend (Go API)
#   - api.capstone-groupe.com/* → Backend (Go API) - direct API access
#
# Prerequisites:
# --------------
# 1. Ingress Controller (nginx-ingress, traefik, etc.) must be installed
# 2. DNS must point capstone-groupe.com to your cluster's external IP
# 3. For TLS: cert-manager or manual certificate
#
# Installing NGINX Ingress Controller:
# ------------------------------------
# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/cloud/deploy.yaml
#
# For minikube:
#   minikube addons enable ingress
#
# For kind:
#   See: https://kind.sigs.k8s.io/docs/user/ingress/
#
# Commands:
#   kubectl apply -f ingress.yaml -n casino
#   kubectl get ingress -n casino
#   kubectl describe ingress casino-ingress -n casino
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: casino-ingress
  namespace: casino
  labels:
    app.kubernetes.io/name: casino-ingress
    app.kubernetes.io/component: networking
    app.kubernetes.io/part-of: casino-capstone
  annotations:
    # -------------------------------------------------------------------------
    # INGRESS CLASS
    # -------------------------------------------------------------------------
    # Specify which ingress controller should handle this Ingress
    kubernetes.io/ingress.class: "nginx"
    
    # -------------------------------------------------------------------------
    # NGINX-SPECIFIC ANNOTATIONS
    # -------------------------------------------------------------------------
    # These annotations configure the NGINX ingress controller behavior
    
    # Enable SSL redirect (HTTP → HTTPS)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    
    # Force SSL redirect even for HTTP requests
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Proxy body size limit (for file uploads if needed)
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    
    # Proxy timeouts (increased for WebSocket connections)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"

    # WebSocket support for game service
    nginx.ingress.kubernetes.io/websocket-services: "game-service"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"
    
    # Enable CORS (if not handled by backend)
    # nginx.ingress.kubernetes.io/enable-cors: "true"
    # nginx.ingress.kubernetes.io/cors-allow-origin: "https://capstone-groupe.com"
    # nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    
    # Rate limiting (optional)
    # nginx.ingress.kubernetes.io/limit-rps: "100"
    # nginx.ingress.kubernetes.io/limit-connections: "50"
    
    # -------------------------------------------------------------------------
    # CERT-MANAGER ANNOTATIONS (for automatic TLS)
    # -------------------------------------------------------------------------
    # Uncomment if using cert-manager for automatic Let's Encrypt certificates
    
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # cert-manager.io/acme-challenge-type: "http01"
    
    # -------------------------------------------------------------------------
    # CUSTOM ANNOTATIONS
    # -------------------------------------------------------------------------
    description: "Main ingress for Casino Capstone application"

spec:
  # Ingress class name (Kubernetes 1.18+)
  ingressClassName: nginx
  
  # ---------------------------------------------------------------------------
  # TLS CONFIGURATION
  # ---------------------------------------------------------------------------
  # Enable HTTPS for the domain
  # The certificate can be:
  #   1. Automatically provisioned by cert-manager
  #   2. Manually created as a Kubernetes Secret
  
  tls:
    - hosts:
        - capstone-groupe.com
        - www.capstone-groupe.com
        - api.capstone-groupe.com
      # Secret containing TLS certificate and key
      # Create with: kubectl create secret tls casino-tls --cert=cert.pem --key=key.pem -n casino
      # Or let cert-manager create it automatically
      secretName: casino-tls-secret
  
  # ---------------------------------------------------------------------------
  # ROUTING RULES
  # ---------------------------------------------------------------------------
  rules:
    # Main domain: capstone-groupe.com
    - host: capstone-groupe.com
      http:
        paths:
          # API routes → Backend service
          # This must come BEFORE the frontend catch-all
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8080
          
          # Health check endpoint → Backend
          - path: /health
            pathType: Exact
            backend:
              service:
                name: backend
                port:
                  number: 8080

          # WebSocket game connections → Game Service
          # Handles real-time game streaming via WebSocket
          - path: /ws/game
            pathType: Prefix
            backend:
              service:
                name: game-service
                port:
                  number: 8000

          # All other routes → Frontend service
          # React Router handles client-side routing
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
    
    # WWW subdomain: www.capstone-groupe.com
    # Same routing as main domain
    - host: www.capstone-groupe.com
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8080

          - path: /health
            pathType: Exact
            backend:
              service:
                name: backend
                port:
                  number: 8080

          - path: /ws/game
            pathType: Prefix
            backend:
              service:
                name: game-service
                port:
                  number: 8000

          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80

    # API subdomain: api.capstone-groupe.com
    # Direct access to backend API without /api prefix
    - host: api.capstone-groupe.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8080

---
# =============================================================================
# TLS CERTIFICATE SECRET (Manual Creation)
# =============================================================================
# If not using cert-manager, create a TLS secret manually.
# This is a placeholder - replace with your actual certificate.
#
# To create from files:
#   kubectl create secret tls casino-tls-secret \
#     --cert=path/to/tls.crt \
#     --key=path/to/tls.key \
#     -n casino
#
# For local development, you can generate a self-signed certificate:
#   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout tls.key -out tls.crt \
#     -subj "/CN=capstone-groupe.com"
#   kubectl create secret tls casino-tls-secret --cert=tls.crt --key=tls.key -n casino
# =============================================================================

# Uncomment to create a placeholder secret (replace with real cert in production)
# apiVersion: v1
# kind: Secret
# metadata:
#   name: casino-tls-secret
#   namespace: casino
#   labels:
#     app.kubernetes.io/name: casino-ingress
# type: kubernetes.io/tls
# data:
#   tls.crt: <base64-encoded-certificate>
#   tls.key: <base64-encoded-private-key>

---
# =============================================================================
# CERT-MANAGER CLUSTERISSUER (For Automatic TLS)
# =============================================================================
# If using cert-manager for automatic Let's Encrypt certificates,
# apply this ClusterIssuer first.
#
# Install cert-manager:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
# =============================================================================

# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     # Let's Encrypt production server
#     server: https://acme-v02.api.letsencrypt.org/directory
#     # Email for certificate notifications
#     email: admin@capstone-groupe.com
#     # Secret to store the ACME account private key
#     privateKeySecretRef:
#       name: letsencrypt-prod-account-key
#     # HTTP-01 challenge solver
#     solvers:
#       - http01:
#           ingress:
#             class: nginx

---
# =============================================================================
# LOCAL DEVELOPMENT INGRESS
# =============================================================================
# For local development without a real domain, you can use localhost
# or add entries to /etc/hosts:
#   127.0.0.1 capstone-groupe.com
#   127.0.0.1 www.capstone-groupe.com
#
# Then access via minikube tunnel or port-forward.
# =============================================================================

# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: casino-ingress-local
#   namespace: casino
#   annotations:
#     kubernetes.io/ingress.class: "nginx"
#     nginx.ingress.kubernetes.io/ssl-redirect: "false"
# spec:
#   ingressClassName: nginx
#   rules:
#     - host: localhost
#       http:
#         paths:
#           - path: /api
#             pathType: Prefix
#             backend:
#               service:
#                 name: backend
#                 port:
#                   number: 8080
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: frontend
#                 port:
#                   number: 80

---
# =============================================================================
# INGRESS CONFIGURATION NOTES
# =============================================================================
#
# Path Types:
# -----------
#   Prefix: Matches URL paths that begin with the specified path
#   Exact: Matches the URL path exactly
#   ImplementationSpecific: Matching depends on the IngressClass
#
#
# Path Priority:
# --------------
# Paths are matched in order of specificity:
#   1. Exact paths first
#   2. Longer prefix paths before shorter ones
#   3. Within same length, alphabetical order
#
# Our configuration:
#   /api/* → Backend (Prefix, longer)
#   /health → Backend (Exact)
#   /* → Frontend (Prefix, catch-all)
#
#
# DNS Configuration:
# ------------------
# Add these DNS records pointing to your cluster's external IP:
#   A     capstone-groupe.com      <cluster-external-ip>
#   A     www.capstone-groupe.com  <cluster-external-ip>
#
# Or use CNAME if you have a load balancer hostname:
#   CNAME capstone-groupe.com      <load-balancer-hostname>
#
#
# Get External IP:
# ----------------
# kubectl get svc -n ingress-nginx
# # Look for the EXTERNAL-IP of the ingress-nginx-controller service
#
# For minikube:
#   minikube ip
#   # Then run: minikube tunnel (in a separate terminal)
#
#
# Testing:
# --------
# curl -H "Host: capstone-groupe.com" http://<external-ip>/
# curl -H "Host: capstone-groupe.com" http://<external-ip>/api/health
#
# With /etc/hosts entry:
# curl https://capstone-groupe.com/
# curl https://capstone-groupe.com/api/health
#
#
# Troubleshooting:
# ----------------
# 1. Check ingress controller is running:
#    kubectl get pods -n ingress-nginx
#
# 2. Check ingress events:
#    kubectl describe ingress casino-ingress -n casino
#
# 3. Check ingress controller logs:
#    kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
#
# 4. Verify backend services are accessible:
#    kubectl port-forward svc/frontend 8080:80 -n casino
#    kubectl port-forward svc/backend 8081:8080 -n casino
#
# =============================================================================